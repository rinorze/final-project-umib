<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Saved Jobs - Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap"
      rel="stylesheet" />
    <link rel="stylesheet" href="/style/base.css" />
    <link rel="stylesheet" href="/style/dashboard.css" />
    <link rel="stylesheet" href="/style/jobs.css" />
  </head>
  <body class="dashboard-body">
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <div class="dashboard-layout">
      <aside class="dashboard-sidebar" id="dashboardSidebar">
        <div class="d-flex align-items-center justify-content-between w-100">
          <a href="/index.html" class="dashboard-brand">
            <img src="/images/job-logo.png" alt="Job Portal Logo" />
          </a>
          <button class="mobile-toggle d-lg-none" id="closeSidebar">
            <i class="fa-solid fa-times"></i>
          </button>
        </div>

        <nav class="dashboard-nav">
          <a class="dashboard-link" href="/dashboard/index.html">
            <i class="fa-solid fa-house"></i> Dashboard
          </a>
          <a class="dashboard-link active" href="/dashboard/saved.html">
            <i class="fa-solid fa-bookmark"></i> Saved Jobs
          </a>
          <a class="dashboard-link" href="/dashboard/applied.html" id="nav-applied">
            <i class="fa-solid fa-paper-plane"></i> Applied
          </a>
          <a class="dashboard-link" href="/dashboard/add-job.html" id="nav-post-job">
            <i class="fa-solid fa-plus"></i> Post Job
          </a>
          <a class="dashboard-link" href="/dashboard/applications.html" id="nav-applications">
            <i class="fa-solid fa-users"></i> Applications
          </a>
          <a class="dashboard-link" href="/dashboard/documents.html" id="nav-documents">
            <i class="fa-solid fa-folder-open"></i> Documents
          </a>
          <a class="dashboard-link" href="/dashboard/analytics.html">
            <i class="fa-solid fa-chart-line"></i> Analytics
          </a>
          <a class="dashboard-link" href="/dashboard/profile.html">
            <i class="fa-solid fa-user"></i> Profile
          </a>
          <a class="dashboard-link" href="/dashboard/settings.html">
            <i class="fa-solid fa-gear"></i> Settings
          </a>
        </nav>

        <div class="dashboard-actions">
          <button id="logoutBtn" class="btn btn-md btn-signup w-100">
            Logout
          </button>
        </div>
      </aside>

      <main class="dashboard-main">
        <div class="container-fluid" style="max-width: 1100px">
          <div class="dashboard-top mb-4">
            <div class="d-flex align-items-center gap-3">
              <button class="mobile-toggle" id="openSidebar">
                <i class="fa-solid fa-bars"></i>
              </button>
              <div>
                <h1 class="dashboard-title">Saved Jobs</h1>
                <p class="dashboard-subtitle">Your bookmarks.</p>
              </div>
            </div>
            <div class="dashboard-top-actions">
              <button id="clearBtn" class="btn btn-outline-red">
                Clear saved
              </button>
            </div>
          </div>

          <div
            id="emptyState"
            class="p-4 rounded-4"
            style="background: #f5f5f5">
            <h5 class="mb-2" style="font-weight: 700">No saved jobs yet</h5>
            <p class="mb-0">Browse jobs and hit “Save” to add them here.</p>
          </div>

          <div id="savedList" class="row g-3 d-none"></div>
        </div>
      </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/9f730657c2.js" crossorigin="anonymous"></script>

    <script type="module">
      import {
        requireAuth,
        signOut,
        getSavedJobs,
        clearSavedJobs,
        toggleSavedJob,
        getCustomJobs
      , setupRoleBasedSidebar} from "/js/auth.js";

      requireAuth({ redirectTo: "/signin.html" });
      setupRoleBasedSidebar();

      const emptyState = document.getElementById("emptyState");
      const list = document.getElementById("savedList");
      const clearBtn = document.getElementById("clearBtn");

      function getJobUrl(jobId) {
        return `/job.html?id=${encodeURIComponent(jobId)}`;
      }

      async function loadAllJobs() {
        const res = await fetch("/data/data.json");
        const data = await res.json();
        const jobs = [...(data.jobs || []), ...getCustomJobs()];
        return { data, jobs };
      }

      async function render() {
        const savedIds = getSavedJobs();
        if (!savedIds.length) {
          emptyState.classList.remove("d-none");
          list.classList.add("d-none");
          list.innerHTML = "";
          return;
        }

        const { data, jobs } = await loadAllJobs();
        const byId = new Map(jobs.map((j) => [String(j.id), j]));

        const cards = savedIds
          .map((id) => byId.get(String(id)))
          .filter(Boolean)
          .map((job) => {
            const company = (data.companies || []).find(
              (c) => c.id === job.companyId
            );
            return `
              <div class="col-lg-4 col-md-6">
                <div class="job-card" data-job-card="${job.id}">
                  <div>
                    <div class="job-top">
                      <div class="company-logo">
                        ${
                          company?.logo
                            ? `<img src="/${company.logo}" alt="${company.name} Logo">`
                            : ""
                        }
                      </div>

                      <button class="save-btn" data-remove="${job.id}">
                        Remove <i class="fa-regular fa-trash-can"></i>
                      </button>
                    </div>

                    <h6 class="company-name">${company?.name || ""}</h6>
                    <h5 class="job-title">${job.title}</h5>

                    <div class="job-tags">
                      <span>${job.type}</span>
                      <span>${job.category}</span>
                    </div>
                  </div>

                  <div class="job-footer">
                    <div>
                      <strong>${job.salary || ""}</strong>
                      <small>${company?.location || job.location || ""}</small>
                    </div>
                    <a class="btn-apply" href="${getJobUrl(job.id)}">View</a>
                  </div>
                </div>
              </div>
            `;
          })
          .join("");

        emptyState.classList.add("d-none");
        list.classList.remove("d-none");
        list.innerHTML = cards;

        list.querySelectorAll("[data-job-card]").forEach((card) => {
          card.addEventListener("click", (e) => {
            const t = e.target;
            if (t && (t.closest("button") || t.closest("a"))) return;
            const jobId = card.getAttribute("data-job-card");
            if (!jobId) return;
            window.location.href = getJobUrl(jobId);
          });
        });

        list.querySelectorAll("[data-remove]").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            const jobId = btn.getAttribute("data-remove");
            toggleSavedJob(jobId);
            render().catch((err) => console.error(err));
          });
        });
      }

      clearBtn.addEventListener("click", () => {
        clearSavedJobs();
        render().catch((err) => console.error(err));
      });

      document.getElementById("logoutBtn").addEventListener("click", () => {
        signOut();
        window.location.href = "/signin.html";
      });

      const sidebar = document.getElementById("dashboardSidebar");
      const overlay = document.getElementById("sidebarOverlay");
      const openBtn = document.getElementById("openSidebar");
      const closeBtn = document.getElementById("closeSidebar");

      function openSidebar() {
        sidebar.classList.add("open");
        overlay.classList.add("active");
        document.body.style.overflow = "hidden";
      }

      function closeSidebar() {
        sidebar.classList.remove("open");
        overlay.classList.remove("active");
        document.body.style.overflow = "";
      }

      openBtn?.addEventListener("click", openSidebar);
      closeBtn?.addEventListener("click", closeSidebar);
      overlay?.addEventListener("click", closeSidebar);

      render().catch((err) => console.error(err));
    </script>
  </body>
</html>
