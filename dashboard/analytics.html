<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Analytics - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/style/base.css" />
    <link rel="stylesheet" href="/style/dashboard.css" />
    <link rel="stylesheet" href="/style/analytics.css" />
  </head>
  <body class="dashboard-body">
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <div class="dashboard-layout">
      <aside class="dashboard-sidebar" id="dashboardSidebar">
        <div class="d-flex align-items-center justify-content-between w-100">
          <a href="/index.html" class="dashboard-brand">
            <img src="/images/job-logo.png" alt="Job Portal Logo" />
          </a>
          <button class="mobile-toggle d-lg-none" id="closeSidebar">
            <i class="fa-solid fa-times"></i>
          </button>
        </div>

        <nav class="dashboard-nav">
          <a class="dashboard-link" href="/dashboard/index.html">
            <i class="fa-solid fa-house"></i> Dashboard
          </a>
          <a class="dashboard-link" href="/dashboard/saved.html">
            <i class="fa-solid fa-bookmark"></i> Saved Jobs
          </a>
          <a class="dashboard-link" href="/dashboard/applied.html" id="nav-applied">
            <i class="fa-solid fa-paper-plane"></i> Applied
          </a>
          <a class="dashboard-link" href="/dashboard/add-job.html" id="nav-post-job">
            <i class="fa-solid fa-plus"></i> Post Job
          </a>
          <a class="dashboard-link" href="/dashboard/applications.html" id="nav-applications">
            <i class="fa-solid fa-users"></i> Applications
          </a>
          <a class="dashboard-link" href="/dashboard/documents.html" id="nav-documents">
            <i class="fa-solid fa-folder-open"></i> Documents
          </a>
          <a class="dashboard-link active" href="/dashboard/analytics.html">
            <i class="fa-solid fa-chart-line"></i> Analytics
          </a>
          <a class="dashboard-link" href="/dashboard/profile.html">
            <i class="fa-solid fa-user"></i> Profile
          </a>
          <a class="dashboard-link" href="/dashboard/settings.html">
            <i class="fa-solid fa-gear"></i> Settings
          </a>
        </nav>

        <div class="dashboard-actions">
          <button id="logoutBtn" class="btn btn-signup w-100">Logout</button>
        </div>
      </aside>

      <main class="dashboard-main">
        <div class="container-fluid" style="max-width: 1100px">
          <div class="dashboard-top">
            <div class="d-flex align-items-center gap-3">
              <button class="mobile-toggle" id="openSidebar">
                <i class="fa-solid fa-bars"></i>
              </button>
              <div>
                <h1 class="dashboard-title">Analytics</h1>
                <p class="dashboard-subtitle">Track your job postings performance</p>
              </div>
            </div>
          </div>

          <div class="row g-4 mb-4">
            <div class="col-md-3 col-6">
              <div class="analytics-stat-card">
                <div class="analytics-stat-icon" style="background: rgba(76, 175, 80, 0.1); color: #4caf50;">
                  <i class="fa-solid fa-eye"></i>
                </div>
                <div class="analytics-stat-value" id="totalViews">0</div>
                <div class="analytics-stat-label">Total Views</div>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="analytics-stat-card">
                <div class="analytics-stat-icon" style="background: rgba(33, 150, 243, 0.1); color: #2196f3;">
                  <i class="fa-solid fa-paper-plane"></i>
                </div>
                <div class="analytics-stat-value" id="totalApplications">0</div>
                <div class="analytics-stat-label">Applications</div>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="analytics-stat-card">
                <div class="analytics-stat-icon" style="background: rgba(255, 152, 0, 0.1); color: #ff9800;">
                  <i class="fa-solid fa-percent"></i>
                </div>
                <div class="analytics-stat-value" id="avgConversion">0%</div>
                <div class="analytics-stat-label">Conversion Rate</div>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="analytics-stat-card">
                <div class="analytics-stat-icon" style="background: rgba(183, 28, 28, 0.1); color: var(--red);">
                  <i class="fa-solid fa-briefcase"></i>
                </div>
                <div class="analytics-stat-value" id="activeJobs">0</div>
                <div class="analytics-stat-label">Posted Jobs</div>
              </div>
            </div>
          </div>

          <div class="analytics-section">
            <div class="analytics-section-header">
              <h3><i class="fa-solid fa-coins me-2"></i>Salary Insights by Category</h3>
              <p class="text-muted mb-0">Market salary ranges in Kosovo (EUR/month)</p>
            </div>
            <div class="analytics-section-body">
              <div class="row g-3" id="salaryInsights"></div>
            </div>
          </div>

          <div class="analytics-section">
            <div class="analytics-section-header">
              <h3><i class="fa-solid fa-table me-2"></i>Job Performance</h3>
              <p class="text-muted mb-0">Detailed analytics for your posted jobs</p>
            </div>
            <div class="analytics-section-body">
              <div id="jobPerformanceEmpty" class="text-center py-5 text-muted">
                <i class="fa-solid fa-chart-bar mb-3" style="font-size: 3rem; opacity: 0.3;"></i>
                <h5>No jobs posted yet</h5>
                <p>Post a job to start tracking its performance</p>
                <a href="/dashboard/add-job.html" class="btn btn-signup">
                  <i class="fa-solid fa-plus me-2"></i>Post a Job
                </a>
              </div>
              <div class="table-responsive d-none" id="jobPerformanceTable">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Job Title</th>
                      <th>Views</th>
                      <th>Applications</th>
                      <th>Conversion</th>
                      <th>Posted</th>
                    </tr>
                  </thead>
                  <tbody id="jobPerformanceBody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="analytics-section">
            <div class="analytics-section-header">
              <h3><i class="fa-solid fa-clock-rotate-left me-2"></i>Application History</h3>
              <p class="text-muted mb-0">Your recent job applications and their status</p>
            </div>
            <div class="analytics-section-body">
              <div id="applicationHistoryEmpty" class="text-center py-5 text-muted">
                <i class="fa-solid fa-paper-plane mb-3" style="font-size: 3rem; opacity: 0.3;"></i>
                <h5>No applications yet</h5>
                <p>Start applying to jobs to track your progress</p>
                <a href="/jobs.html" class="btn btn-signup">
                  <i class="fa-solid fa-briefcase me-2"></i>Browse Jobs
                </a>
              </div>
              <div id="applicationHistoryList" class="d-none"></div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/9f730657c2.js" crossorigin="anonymous"></script>

    <script type="module">
      import { 
        requireAuth, signOut, getAppliedJobs, getCustomJobs,
        getAllJobsAnalytics, getJobAnalytics, getSalaryInsights
      , setupRoleBasedSidebar} from "/js/auth.js";

      requireAuth({ redirectTo: "/signin.html" });
      setupRoleBasedSidebar();

      async function loadData() {
        const res = await fetch("/data/data.json");
        const data = await res.json();
        return data;
      }

      async function render() {
        const data = await loadData();
        const customJobs = getCustomJobs();
        const allJobs = [...data.jobs, ...customJobs];
        const analytics = getAllJobsAnalytics();
        const applied = getAppliedJobs();

        let totalViews = 0;
        let totalApps = 0;
        
        Object.values(analytics).forEach(a => {
          totalViews += a.views || 0;
          totalApps += a.applications || 0;
        });

        const avgConversion = totalViews > 0 ? Math.round((totalApps / totalViews) * 100) : 0;

        document.getElementById("totalViews").textContent = totalViews.toLocaleString();
        document.getElementById("totalApplications").textContent = totalApps.toLocaleString();
        document.getElementById("avgConversion").textContent = avgConversion + "%";
        document.getElementById("activeJobs").textContent = customJobs.length;

        const salaryData = getSalaryInsights();
        const salaryContainer = document.getElementById("salaryInsights");
        salaryContainer.innerHTML = Object.entries(salaryData).map(([category, data]) => {
          const percentile = ((data.avg - data.min) / (data.max - data.min)) * 100;
          return `
            <div class="col-md-4 col-sm-6">
              <div class="salary-card">
                <div class="salary-card-title">${category}</div>
                <div class="salary-bar">
                  <div class="salary-bar-fill" style="width: ${percentile}%"></div>
                </div>
                <div class="salary-range">
                  <span>${data.min}€</span>
                  <span>${data.max}€</span>
                </div>
                <div class="salary-avg">Avg: ${data.avg}€</div>
              </div>
            </div>
          `;
        }).join("");

        if (customJobs.length > 0) {
          document.getElementById("jobPerformanceEmpty").classList.add("d-none");
          document.getElementById("jobPerformanceTable").classList.remove("d-none");

          const tbody = document.getElementById("jobPerformanceBody");
          tbody.innerHTML = customJobs.map(job => {
            const jobAnalytics = getJobAnalytics(job.id);
            return `
              <tr>
                <td>
                  <strong>${job.title}</strong>
                  <div class="text-muted" style="font-size: 13px;">${job.category}</div>
                </td>
                <td>${jobAnalytics.views}</td>
                <td>${jobAnalytics.applications}</td>
                <td>
                  <span class="badge ${jobAnalytics.conversionRate > 10 ? 'bg-success' : jobAnalytics.conversionRate > 5 ? 'bg-warning' : 'bg-secondary'}">
                    ${jobAnalytics.conversionRate}%
                  </span>
                </td>
                <td>${new Date(job.postedDate).toLocaleDateString()}</td>
              </tr>
            `;
          }).join("");
        }

        if (applied.length > 0) {
          document.getElementById("applicationHistoryEmpty").classList.add("d-none");
          const historyList = document.getElementById("applicationHistoryList");
          historyList.classList.remove("d-none");

          const jobsById = new Map(allJobs.map(j => [String(j.id), j]));
          const companiesById = new Map(data.companies.map(c => [c.id, c]));

          historyList.innerHTML = applied.slice(0, 10).map(app => {
            const job = jobsById.get(String(app.jobId));
            if (!job) return "";
            const company = companiesById.get(job.companyId);
            const status = app.status || "pending";
            const statusLabels = {
              pending: "Pending",
              reviewed: "Under Review",
              interview: "Interview",
              rejected: "Rejected",
              accepted: "Accepted"
            };

            return `
              <div class="application-history-item">
                <div class="history-company-logo">
                  ${company?.logo ? `<img src="/${company.logo}" alt="${company?.name}">` : '<i class="fa-solid fa-building"></i>'}
                </div>
                <div class="history-info">
                  <h5 class="history-title">${job.title}</h5>
                  <p class="history-company">${company?.name || "Unknown Company"}</p>
                </div>
                <div class="history-meta">
                  <div class="history-date">${new Date(app.appliedAt).toLocaleDateString()}</div>
                  <span class="history-status status-${status}">${statusLabels[status]}</span>
                </div>
              </div>
            `;
          }).join("");
        }
      }

      const sidebar = document.getElementById("dashboardSidebar");
      const overlay = document.getElementById("sidebarOverlay");
      const openBtn = document.getElementById("openSidebar");
      const closeBtn = document.getElementById("closeSidebar");

      function openSidebar() {
        sidebar.classList.add("open");
        overlay.classList.add("active");
        document.body.style.overflow = "hidden";
      }

      function closeSidebar() {
        sidebar.classList.remove("open");
        overlay.classList.remove("active");
        document.body.style.overflow = "";
      }

      openBtn?.addEventListener("click", openSidebar);
      closeBtn?.addEventListener("click", closeSidebar);
      overlay?.addEventListener("click", closeSidebar);

      document.getElementById("logoutBtn").addEventListener("click", () => {
        signOut();
        window.location.href = "/signin.html";
      });

      render();
    </script>
  </body>
</html>
