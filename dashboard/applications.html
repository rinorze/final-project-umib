<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Applications - Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap"
      rel="stylesheet" />
    <link rel="stylesheet" href="/style/base.css" />
    <link rel="stylesheet" href="/style/dashboard.css" />
    <link rel="stylesheet" href="/style/applications.css" />
  </head>
  <body class="dashboard-body">
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <div class="dashboard-layout">
      <aside class="dashboard-sidebar" id="dashboardSidebar">
        <div class="d-flex align-items-center justify-content-between w-100">
          <a href="/index.html" class="dashboard-brand">
            <img src="/images/job-logo.png" alt="Job Portal Logo" />
          </a>
          <button class="mobile-toggle d-lg-none" id="closeSidebar">
            <i class="fa-solid fa-times"></i>
          </button>
        </div>

        <nav class="dashboard-nav">
          <a class="dashboard-link" href="/dashboard/index.html">
            <i class="fa-solid fa-house"></i> Dashboard
          </a>
          <a class="dashboard-link" href="/dashboard/saved.html">
            <i class="fa-solid fa-bookmark"></i> Saved Jobs
          </a>
          <a class="dashboard-link" href="/dashboard/applied.html" id="nav-applied">
            <i class="fa-solid fa-paper-plane"></i> Applied
          </a>
          <a class="dashboard-link" href="/dashboard/add-job.html" id="nav-post-job">
            <i class="fa-solid fa-plus"></i> Post Job
          </a>
          <a class="dashboard-link active" href="/dashboard/applications.html" id="nav-applications">
            <i class="fa-solid fa-users"></i> Applications
          </a>
          <a class="dashboard-link" href="/dashboard/documents.html" id="nav-documents">
            <i class="fa-solid fa-folder-open"></i> Documents
          </a>
          <a class="dashboard-link" href="/dashboard/analytics.html">
            <i class="fa-solid fa-chart-line"></i> Analytics
          </a>
          <a class="dashboard-link" href="/dashboard/profile.html">
            <i class="fa-solid fa-user"></i> Profile
          </a>
          <a class="dashboard-link" href="/dashboard/settings.html">
            <i class="fa-solid fa-gear"></i> Settings
          </a>
        </nav>

        <div class="dashboard-actions">
          <button id="logoutBtn" class="btn btn-md btn-signup w-100">Logout</button>
        </div>
      </aside>

      <main class="dashboard-main">
        <div class="container-fluid" style="max-width: 1100px">
          <div class="dashboard-top mb-4">
            <div class="d-flex align-items-center gap-3">
              <button class="mobile-toggle" id="openSidebar">
                <i class="fa-solid fa-bars"></i>
              </button>
              <div>
                <h1 class="dashboard-title">Applications</h1>
                <p class="dashboard-subtitle">Manage job applications from candidates</p>
              </div>
            </div>
            <div class="dashboard-top-actions flex-wrap">
              <select id="filterJob" class="form-select form-select-sm" style="width: auto; min-width: 140px;">
                <option value="">All Jobs</option>
              </select>
              <select id="filterStatus" class="form-select form-select-sm" style="width: auto; min-width: 120px;">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="reviewed">Reviewed</option>
                <option value="interview">Interview</option>
                <option value="accepted">Accepted</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
          </div>

          <div id="emptyState" class="dashboard-empty">
            <div class="dashboard-empty-icon">
              <i class="fa-solid fa-users"></i>
            </div>
            <h5>No applications yet</h5>
            <p>When candidates apply to your jobs, they'll appear here.</p>
            <a href="/dashboard/add-job.html" class="btn btn-signup">Post a Job</a>
          </div>

          <div id="applicationsList" class="row g-4 d-none"></div>
        </div>
      </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/9f730657c2.js" crossorigin="anonymous"></script>
    <script type="module">
      import {
        requireAuth,
        signOut,
        getCurrentUser,
        getUserRole,
        USER_ROLES,
        setupRoleBasedSidebar,
        getApplicationsForEmployer,
        updateApplicationStatusByEmployer,
        getCustomJobs
      } from "/js/auth.js";

      requireAuth({ redirectTo: "/signin.html" });
      setupRoleBasedSidebar();

      const user = getCurrentUser();
      const role = getUserRole(user);
      if (role === USER_ROLES.JOBSEEKER) {
        alert("This page is for employers only.");
        window.location.href = "/dashboard/index.html";
      }

      const emptyState = document.getElementById("emptyState");
      const list = document.getElementById("applicationsList");
      const filterJob = document.getElementById("filterJob");
      const filterStatus = document.getElementById("filterStatus");

      let allApplications = [];
      let staticJobs = [];

      async function loadStaticJobs() {
        try {
          const res = await fetch("/data/data.json");
          const data = await res.json();
          staticJobs = data.jobs || [];
        } catch (e) {
          console.error("Failed to load static jobs:", e);
        }
      }

      function getStatusBadge(status) {
        const statusConfig = {
          pending: { label: "Pending", class: "bg-warning text-dark", icon: "fa-clock" },
          reviewed: { label: "Reviewed", class: "bg-info text-white", icon: "fa-eye" },
          interview: { label: "Interview", class: "bg-primary text-white", icon: "fa-calendar-check" },
          rejected: { label: "Rejected", class: "bg-danger text-white", icon: "fa-times-circle" },
          accepted: { label: "Accepted", class: "bg-success text-white", icon: "fa-check-circle" }
        };
        const config = statusConfig[status] || statusConfig.pending;
        return `<span class="badge ${config.class}"><i class="fa-solid ${config.icon} me-1"></i>${config.label}</span>`;
      }

      function populateJobFilter() {
        const customJobs = getCustomJobs();
        const role = getUserRole(user);
        
        let jobs;
        if (role === USER_ROLES.ADMIN) {
          jobs = [...customJobs, ...staticJobs];
        } else {
          jobs = customJobs.filter(j => j.postedBy === user.id);
        }
        
        jobs.forEach(job => {
          const option = document.createElement('option');
          option.value = job.id;
          option.textContent = job.title;
          filterJob.appendChild(option);
        });
        
        if (jobs.length === 0 && role !== USER_ROLES.ADMIN) {
          emptyState.querySelector('h5').textContent = "No jobs posted yet";
          emptyState.querySelector('p').textContent = "Post a job first, then candidates can apply to it.";
        }
      }

      function render() {
        allApplications = getApplicationsForEmployer(staticJobs);
        
        let filtered = allApplications;
        const jobFilter = filterJob.value;
        const statusFilter = filterStatus.value;
        
        if (jobFilter) {
          filtered = filtered.filter(a => String(a.jobId) === jobFilter);
        }
        if (statusFilter) {
          filtered = filtered.filter(a => a.status === statusFilter);
        }

        if (!filtered.length) {
          emptyState.classList.remove("d-none");
          list.classList.add("d-none");
          list.innerHTML = "";
          return;
        }

        emptyState.classList.add("d-none");
        list.classList.remove("d-none");

        const cards = filtered.map(app => `
          <div class="col-lg-4 col-md-6">
            <div class="application-card" data-app-id="${app.id}" data-applicant-id="${app.applicant.id}" data-job-id="${app.jobId}">
              <div class="application-header">
                <div class="d-flex align-items-center gap-3">
                  <div class="applicant-avatar">
                    ${app.applicant.photoUrl 
                      ? `<img src="${app.applicant.photoUrl}" alt="${app.applicant.fullName}">`
                      : `<span>${app.applicant.fullName.charAt(0).toUpperCase()}</span>`
                    }
                  </div>
                  <div>
                    <h5 class="applicant-name mb-1">${app.applicant.fullName}</h5>
                    <p class="applicant-email mb-0">${app.applicant.email}</p>
                  </div>
                </div>
              </div>
              
              <div class="mt-2 mb-2">${getStatusBadge(app.status || 'pending')}</div>
              
              <div class="application-job">
                <i class="fa-solid fa-briefcase me-2"></i>
                <strong>${app.job?.title || 'Unknown Job'}</strong>
              </div>
              
              <div class="application-details">
                ${app.applicant.phone ? `<span><i class="fa-solid fa-phone me-1"></i>${app.applicant.phone}</span>` : ''}
                ${app.applicant.location ? `<span><i class="fa-solid fa-location-dot me-1"></i>${app.applicant.location}</span>` : ''}
                <span><i class="fa-solid fa-calendar me-1"></i>${new Date(app.appliedAt).toLocaleDateString()}</span>
              </div>
              
              ${app.applicant.skills && app.applicant.skills.length > 0 ? `
                <div class="applicant-skills">
                  ${app.applicant.skills.slice(0, 4).map(skill => `<span class="skill-tag">${skill}</span>`).join('')}
                  ${app.applicant.skills.length > 4 ? `<span class="skill-tag">+${app.applicant.skills.length - 4}</span>` : ''}
                </div>
              ` : ''}
              
              <div class="application-actions">
                <select class="form-select form-select-sm status-select" data-applicant-id="${app.applicant.id}" data-job-id="${app.jobId}">
                  <option value="pending" ${app.status === 'pending' ? 'selected' : ''}>Pending</option>
                  <option value="reviewed" ${app.status === 'reviewed' ? 'selected' : ''}>Reviewed</option>
                  <option value="interview" ${app.status === 'interview' ? 'selected' : ''}>Interview</option>
                  <option value="accepted" ${app.status === 'accepted' ? 'selected' : ''}>Accepted</option>
                  <option value="rejected" ${app.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                </select>
                <a href="mailto:${app.applicant.email}" class="btn btn-sm btn-outline-red" title="Contact">
                  <i class="fa-solid fa-envelope"></i>
                </a>
              </div>
            </div>
          </div>
        `).join("");

        list.innerHTML = cards;

        list.querySelectorAll(".status-select").forEach(select => {
          select.addEventListener("change", (e) => {
            const applicantId = select.dataset.applicantId;
            const jobId = select.dataset.jobId;
            const newStatus = select.value;
            
            const result = updateApplicationStatusByEmployer(applicantId, jobId, newStatus);
            if (result.ok) {
              render();
            } else {
              alert(result.message || "Failed to update status");
            }
          });
        });
      }

      filterJob.addEventListener("change", render);
      filterStatus.addEventListener("change", render);

      document.getElementById("logoutBtn").addEventListener("click", () => {
        signOut();
        window.location.href = "/signin.html";
      });

      const sidebar = document.getElementById("dashboardSidebar");
      const overlay = document.getElementById("sidebarOverlay");
      const openBtn = document.getElementById("openSidebar");
      const closeBtn = document.getElementById("closeSidebar");

      function openSidebar() {
        sidebar.classList.add("open");
        overlay.classList.add("active");
        document.body.style.overflow = "hidden";
      }

      function closeSidebar() {
        sidebar.classList.remove("open");
        overlay.classList.remove("active");
        document.body.style.overflow = "";
      }

      openBtn?.addEventListener("click", openSidebar);
      closeBtn?.addEventListener("click", closeSidebar);
      overlay?.addEventListener("click", closeSidebar);

      async function init() {
        await loadStaticJobs();
        populateJobFilter();
        render();
      }
      init();
    </script>
  </body>
</html>
