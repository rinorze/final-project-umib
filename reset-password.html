<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reset Password - JobPortal</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap"
      rel="stylesheet" />
    <link rel="stylesheet" href="/style/base.css" />
    <link rel="stylesheet" href="/style/auth.css" />
  </head>
  <body id="rz-body-reset-password">
    <nav class="navbar navbar-expand-lg rz-custom-navbar fixed-top">
      <div class="container">
        <a class="navbar-brand fw-bold" href="/index.html">
          <img src="/images/job-logo.png" alt="Job Portal Logo" />
        </a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#mainNavbar"
          aria-controls="mainNavbar"
          aria-expanded="false"
          aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="mainNavbar">
          <ul class="navbar-nav mb-2 mb-lg-0 gap-lg-3">
            <li class="nav-item">
              <a class="nav-link" href="/index.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/jobs.html">Jobs</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/companies.html">Companies</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/about.html">About</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/contact.html">Contact</a>
            </li>
            <li id="navAuth">
              <a href="/signup.html" class="btn btn-md btn-signup">Sign Up</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="rz-main">
      <section class="rz-home-jobs" style="padding: 60px 0">
        <div class="container" style="max-width: 520px">
          <div class="card border-0 shadow-sm">
            <div class="card-body p-4 p-md-5">
              <!-- Reset Form -->
              <div id="resetForm">
                <span class="badge badge-accent mb-2 px-3 py-2 rounded-pill">
                  <i class="fa-solid fa-lock me-1"></i> New Password
                </span>
                <h2 class="mb-2" style="font-weight: 700">
                  Reset your password
                </h2>
                <p class="text-muted mb-4">Enter your new password below.</p>

                <div id="formAlert" class="alert d-none" role="alert"></div>

                <form id="resetPasswordForm" novalidate>
                  <div class="mb-3">
                    <label for="password" class="form-label"
                      >New Password</label
                    >
                    <div class="password-input-group">
                      <input
                        id="password"
                        name="password"
                        type="password"
                        class="form-control"
                        placeholder="••••••••"
                        minlength="6"
                        required />
                      <button
                        type="button"
                        class="password-toggle"
                        id="passwordToggle1">
                        <i class="fa-solid fa-eye"></i>
                      </button>
                    </div>
                    <small class="text-muted"
                      >Must be at least 6 characters</small
                    >
                  </div>

                  <div class="mb-4">
                    <label for="confirmPassword" class="form-label"
                      >Confirm New Password</label
                    >
                    <div class="password-input-group">
                      <input
                        id="confirmPassword"
                        name="confirmPassword"
                        type="password"
                        class="form-control"
                        placeholder="••••••••"
                        minlength="6"
                        required />
                      <button
                        type="button"
                        class="password-toggle"
                        id="passwordToggle2">
                        <i class="fa-solid fa-eye"></i>
                      </button>
                    </div>
                  </div>

                  <button
                    id="submitBtn"
                    type="submit"
                    class="btn btn-signup w-100">
                    <i class="fa-solid fa-check me-2"></i> Reset Password
                  </button>
                </form>
              </div>

              <!-- Success Message -->
              <div id="successMessage" class="d-none text-center">
                <div class="mb-4">
                  <div
                    style="
                      width: 80px;
                      height: 80px;
                      background: rgba(76, 175, 80, 0.1);
                      border-radius: 50%;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      margin: 0 auto;
                    ">
                    <i
                      class="fa-solid fa-check-circle"
                      style="font-size: 2rem; color: #4caf50"></i>
                  </div>
                </div>
                <h3 class="mb-2" style="font-weight: 700">Password Reset!</h3>
                <p class="text-muted mb-4">
                  Your password has been successfully reset. You can now sign in
                  with your new password.
                </p>
                <a href="/signin.html" class="btn btn-signup">
                  <i class="fa-solid fa-right-to-bracket me-2"></i> Sign In
                </a>
              </div>

              <!-- Invalid Token -->
              <div id="invalidToken" class="d-none text-center">
                <div class="mb-4">
                  <div
                    style="
                      width: 80px;
                      height: 80px;
                      background: rgba(244, 67, 54, 0.1);
                      border-radius: 50%;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      margin: 0 auto;
                    ">
                    <i
                      class="fa-solid fa-times-circle"
                      style="font-size: 2rem; color: #f44336"></i>
                  </div>
                </div>
                <h3 class="mb-2" style="font-weight: 700">
                  Invalid or Expired Link
                </h3>
                <p class="text-muted mb-4">
                  This password reset link is invalid or has expired. Please
                  request a new one.
                </p>
                <a href="/forgot-password.html" class="btn btn-signup">
                  <i class="fa-solid fa-rotate-right me-2"></i> Request New Link
                </a>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script
      src="https://kit.fontawesome.com/9f730657c2.js"
      crossorigin="anonymous"></script>

    <script type="module">
      import { resetPassword, redirectIfAuthed } from "/js/auth.js";

      redirectIfAuthed({ to: "/dashboard/index.html" });

      const params = new URLSearchParams(window.location.search);
      const token = params.get("token");

      const resetFormContainer = document.getElementById("resetForm");
      const successMessage = document.getElementById("successMessage");
      const invalidToken = document.getElementById("invalidToken");
      const form = document.getElementById("resetPasswordForm");
      const alertBox = document.getElementById("formAlert");
      const submitBtn = document.getElementById("submitBtn");

      if (!token) {
        resetFormContainer.classList.add("d-none");
        invalidToken.classList.remove("d-none");
      }

      function showAlert(type, message) {
        alertBox.classList.remove("d-none", "alert-danger", "alert-success");
        alertBox.classList.add(
          type === "success" ? "alert-success" : "alert-danger",
        );
        alertBox.textContent = message;
      }

      function setupToggle(toggleId, inputId) {
        const toggle = document.getElementById(toggleId);
        const input = document.getElementById(inputId);
        toggle?.addEventListener("click", () => {
          const icon = toggle.querySelector("i");
          if (input.type === "password") {
            input.type = "text";
            icon.classList.remove("fa-eye");
            icon.classList.add("fa-eye-slash");
          } else {
            input.type = "password";
            icon.classList.remove("fa-eye-slash");
            icon.classList.add("fa-eye");
          }
        });
      }

      setupToggle("passwordToggle1", "password");
      setupToggle("passwordToggle2", "confirmPassword");

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        submitBtn.disabled = true;

        const password = document.getElementById("password").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;

        if (password !== confirmPassword) {
          showAlert("error", "Passwords do not match");
          submitBtn.disabled = false;
          return;
        }

        const res = resetPassword(token, password);

        if (res.ok) {
          resetFormContainer.classList.add("d-none");
          successMessage.classList.remove("d-none");
        } else {
          if (
            res.message.includes("expired") ||
            res.message.includes("Invalid")
          ) {
            resetFormContainer.classList.add("d-none");
            invalidToken.classList.remove("d-none");
          } else {
            showAlert("error", res.message);
            submitBtn.disabled = false;
          }
        }
      });
    </script>
  </body>
</html>
