<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sign In - JobPortal</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap"
      rel="stylesheet" />
    <link rel="stylesheet" href="/style/base.css" />
    <link rel="stylesheet" href="/style/auth.css" />
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg rz-custom-navbar fixed-top">
      <div class="container">
        <a class="navbar-brand fw-bold" href="/index.html">
          <img src="/images/job-logo.png" alt="Job Portal Logo" />
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#mainNavbar"
          aria-controls="mainNavbar"
          aria-expanded="false"
          aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="mainNavbar">
          <ul class="navbar-nav mb-2 mb-lg-0 gap-lg-3">
            <li class="nav-item">
              <a class="nav-link" href="/index.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/jobs.html">Jobs</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/companies.html">Companies</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/about.html">About</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/contact.html">Contact</a>
            </li>
            <li id="navAuth">
              <a href="/signup.html" class="btn btn-md btn-signup">Sign Up</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="rz-main">
      <section class="rz-home-jobs" style="padding: 60px 0">
        <div class="container" style="max-width: 520px">
          <div class="card border-0 shadow-sm">
            <div class="card-body p-4 p-md-5">
              <span class="badge badge-accent mb-2 px-3 py-2 rounded-pill"
                >Account</span
              >
              <h2 class="mb-2" style="font-weight: 700">Welcome back</h2>
              <p class="text-muted mb-4">Sign in to access your dashboard.</p>

              <div id="formAlert" class="alert d-none" role="alert"></div>

              <form id="signinForm" novalidate>
                <div class="mb-3">
                  <label for="email" class="form-label">Email</label>
                  <input
                    id="email"
                    name="email"
                    type="email"
                    class="form-control"
                    placeholder="you@example.com"
                    autocomplete="email"
                    required />
                </div>
                <div class="mb-3">
                  <label for="password" class="form-label">Password</label>
                  <div class="password-input-group">
                    <input
                      id="password"
                      name="password"
                      type="password"
                      class="form-control"
                      placeholder="••••••••"
                      autocomplete="current-password"
                      required />
                    <button
                      type="button"
                      class="password-toggle"
                      id="passwordToggle">
                      <i class="fa-solid fa-eye"></i>
                    </button>
                  </div>
                </div>
                <button
                  id="submitBtn"
                  type="submit"
                  class="btn btn-signup w-100">
                  Sign In
                </button>
              </form>

              <div class="text-end mt-2">
                <a
                  href="/forgot-password.html"
                  style="color: #666; font-size: 14px"
                  >Forgot password?</a
                >
              </div>

              <div class="divider-text my-4"><span>or continue with</span></div>

              <div class="social-login-buttons">
                <button
                  type="button"
                  class="btn btn-social btn-google"
                  id="googleLogin">
                  <svg width="18" height="18" viewBox="0 0 24 24">
                    <path
                      fill="#4285F4"
                      d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                    <path
                      fill="#34A853"
                      d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                    <path
                      fill="#FBBC05"
                      d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                    <path
                      fill="#EA4335"
                      d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                  </svg>
                  Continue with Google
                </button>
              </div>

              <p class="mt-4 mb-0 text-center">
                Don't have an account?
                <a href="/signup.html" style="color: #b71c1c; font-weight: 600"
                  >Sign Up</a
                >
              </p>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script
      src="https://kit.fontawesome.com/9f730657c2.js"
      crossorigin="anonymous"></script>

    <script type="module">
      import { signIn, redirectIfAuthed, googleSignIn } from "/js/auth.js";

      const params = new URLSearchParams(window.location.search);
      const next = params.get("next");
      redirectIfAuthed({ to: next || "/dashboard/index.html" });

      const form = document.getElementById("signinForm");
      const alertBox = document.getElementById("formAlert");
      const submitBtn = document.getElementById("submitBtn");
      const passwordInput = document.getElementById("password");
      const toggleBtn = document.getElementById("passwordToggle");

      function showAlert(type, message) {
        alertBox.classList.remove("d-none", "alert-danger", "alert-success");
        alertBox.classList.add(
          type === "success" ? "alert-success" : "alert-danger",
        );
        alertBox.textContent = message;
      }

      toggleBtn.addEventListener("click", () => {
        const icon = toggleBtn.querySelector("i");
        if (passwordInput.type === "password") {
          passwordInput.type = "text";
          icon.classList.replace("fa-eye", "fa-eye-slash");
        } else {
          passwordInput.type = "password";
          icon.classList.replace("fa-eye-slash", "fa-eye");
        }
      });

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        submitBtn.disabled = true;
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const res = signIn({ email, password });
        if (!res.ok) {
          showAlert("error", res.message);
          submitBtn.disabled = false;
          return;
        }
        window.location.href = next || "/dashboard/index.html";
      });

      const GOOGLE_CLIENT_ID =
        "421754504632-otru98j4a46pteg8b12l0hp5fvf74v9t.apps.googleusercontent.com";
      const isGoogleConfigured =
        GOOGLE_CLIENT_ID && !GOOGLE_CLIENT_ID.includes("YOUR_GOOGLE_CLIENT_ID");

      let googleTokenClient;

      if (isGoogleConfigured) {
        window.onload = function () {
          googleTokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: "email profile",
            callback: handleGoogleTokenResponse,
          });
        };
      }

      async function handleGoogleTokenResponse(tokenResponse) {
        if (tokenResponse.error) {
          showAlert("error", "Google Sign-In failed: " + tokenResponse.error);
          return;
        }

        try {
          const response = await fetch(
            "https://www.googleapis.com/oauth2/v3/userinfo",
            {
              headers: {
                Authorization: `Bearer ${tokenResponse.access_token}`,
              },
            },
          );
          const userInfo = await response.json();

          const res = googleSignIn({
            email: userInfo.email,
            fullName: userInfo.name,
            picture: userInfo.picture,
            googleId: userInfo.sub,
          });

          if (res.ok) {
            showAlert("success", "Signed in with Google!");
            setTimeout(() => {
              window.location.href = next || "/dashboard/index.html";
            }, 500);
          } else {
            showAlert("error", res.message);
          }
        } catch (err) {
          showAlert("error", "Failed to get user info from Google.");
        }
      }

      document.getElementById("googleLogin").addEventListener("click", () => {
        if (!isGoogleConfigured || !googleTokenClient) {
          showAlert(
            "error",
            "Google Sign-In not configured. Please refresh and try again.",
          );
          return;
        }
        googleTokenClient.requestAccessToken();
      });
    </script>
  </body>
</html>
